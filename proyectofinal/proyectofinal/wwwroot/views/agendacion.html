<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - Dr. Cordoba</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e0f7fa; /* celeste suave */
            margin: 0;
            padding: 0;
        }

        table {
            border-collapse: collapse;
            width: 92%;
            margin: 30px auto;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        th, td {
            border: 1px solid #b2dfdb;
            padding: 10px;
            text-align: center;
        }

            /* Columna de horas */
            th.hora, td.hora {
                background: #b2ebf2;
                width: 140px;
                font-weight: 700;
                color: #004d40;
            }

        /* Encabezado */
        .titulo {
            font-family: "Brush Script MT", cursive;
            font-size: 2em;
            font-style: italic;
            background-color: #b2ebf2;
            border: none;
            text-align: center;
            height: 60px;
            vertical-align: middle;
            color: #00695c;
        }

        /* Menú */
        .menu {
            background-color: #e0f2f1;
            font-weight: bold;
            text-align: center;
            padding: 12px 0;
            position: relative;
        }

        .menu-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 4px 12px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(90deg,#00796b 0%, #004d40 100%);
            color: #fff;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 14px rgba(0,0,0,0.1);
            transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
            text-decoration: none;
            white-space: nowrap;
            font-size: 0.95rem;
        }

            .btn.secondary {
                background: #ffffff;
                color: #333;
                border: 1px solid #b2dfdb;
                box-shadow: 0 4px 8px rgba(0,0,0,0.06);
                font-weight: 600;
            }

        /* Iconos */
        .iconos {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icono {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            line-height: 1;
            text-decoration: none;
            color: inherit;
        }

            .icono:hover {
                background: rgba(0,0,0,0.04);
            }

            .icono:focus {
                outline: 3px solid rgba(0,150,136,0.2);
            }

        /* Días */
        .dias {
            background-color: #b2dfdb;
            font-weight: bold;
            color: #004d40;
        }

        /* Celdas */
        td.disponible {
            background-color: #e0f2f1;
            cursor: pointer;
            vertical-align: middle;
        }

        td.ocupado {
            background-color: #ffcdd2;
            color: #444;
            font-weight: bold;
            cursor: default;
        }

        td.disponible:hover {
            background-color: #b2dfdb;
        }

        /* Texto en celda ocupada */
        .cell-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
            display: inline-block;
            vertical-align: middle;
        }

        @media (max-width: 640px) {
            .menu-bar {
                flex-direction: column;
                gap: 8px;
            }

            .iconos {
                right: 8px;
            }

            th.hora, td.hora {
                width: 110px;
                font-size: 0.9rem;
                padding: 8px;
            }

            .cell-text {
                max-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div style="width:92%;margin:24px auto 0 auto;text-align:right;">
        <label for="calendario" style="font-weight:bold;color:#00695c;">Seleccionar semana: </label>
        <input id="calendario" type="text" style="padding:8px 12px;border-radius:6px;border:1px solid #b2dfdb;font-size:1rem;">
    </div>
    <table>
        <tr>
            <td colspan="7" class="titulo">Dr. Cordoba</td>
        </tr>

        <tr class="menu">
            <td colspan="7">
                <div class="menu-bar" role="toolbar" aria-label="Navegación principal">
                    <a class="btn" href="subAgenda.html" role="button">Agenda 📝</a>
                    <a class="btn secondary" href="busqueda_Pacientes.html" role="button">Busqueda de pacientes 👤</a>
                    <a class="btn secondary" href="facturas.html" role="button">Facturas 🧾</a>
                </div>


            </td>
        </tr>

        <tr class="dias">
            <th class="hora">Hora</th>
            <th>Lunes</th>
            <th>Martes</th>
            <th>Miércoles</th>
            <th>Jueves</th>
            <th>Viernes</th>
            <th>Sábado</th>
        </tr>


        <tbody id="agenda-body"></tbody>

    </table>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>

        const filas = 6;
        const franjasHorarias =
            [
            "09:00 - 09:30", "09:30 - 10:00", "10:00 - 10:30",
            "10:30 - 11:00", "11:00 - 11:30", "11:30 - 12:00"
        ];
        const columnas = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];

        function getMonday(d)
        {
            d = new Date(d);
            const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(d)
        {
            return d.toISOString().slice(0, 10);
        }

        function loadCitas()
        {
            try {
                const raw = localStorage.getItem('citas');
                return raw ? JSON.parse(raw) : {};
            } catch (e) {
                console.warn('Error parseando citas desde localStorage:', e);
                return {};
            }
        }

        function saveCitas(citas) {
            localStorage.setItem('citas', JSON.stringify(citas));
        }

        function parseValor(valor)
        {
            const parts = valor.split('·').map(p => p.trim());
            const nombre = parts[0] || '';
            const edad = parts.find(p => p.startsWith("Edad:"))?.split(":")[1]?.trim() || '';
            const motivo = parts.find(p => p.startsWith("Motivo:"))?.split(":")[1]?.trim() || '';
            const hora = parts.find(p => p.includes(":") && p.includes("-")) || '';
            return {
                nombre, edad, motivo, hora
            };
        }

        function obtenerDiaDeLaSemana(fechaStr) {
            const dias = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
            const fecha = new Date(fechaStr);
            return dias[fecha.getDay()];
        }

        function mostrarHoras(fecha) {
            const horaSelect = document.getElementById("hora");
            horaSelect.innerHTML = '<option value="">Seleccione una hora</option>';
            if (!fecha) return;

            const diaSeleccionado = obtenerDiaDeLaSemana(fecha);
            if (!columnas.includes(diaSeleccionado)) return;

            const citasLocales = loadCitas();
            const ocupadasLocales = [];

            Object.entries(citasLocales).forEach(([clave, valor]) => {
                const partes = clave.split('_');
                if (partes.length !== 3) return;
                const [fechaClave, diaClave, indiceClave] = partes;
                if (fechaClave === fecha && diaClave === diaSeleccionado) {
                    const franja = franjasHorarias[parseInt(indiceClave)];
                    if (franja) ocupadasLocales.push(franja);
                }
            });

            franjasHorarias.forEach(h => {
                const option = document.createElement("option");
                option.value = h;
                option.textContent = ocupadasLocales.includes(h) ? `${h} (Ocupado)` : h;
                option.disabled = ocupadasLocales.includes(h);
                horaSelect.appendChild(option);
            });
        }

        window.onload = function () {
            const fechaInput = document.getElementById("fecha");
            const hoy = formatDate(new Date());
            const datos = localStorage.getItem("datosSubAgendacion");
            if (datos) {
                try {
                    const { nombre, edad, motivo, fecha, hora } = JSON.parse(datos);
                    localStorage.removeItem("datosSubAgendacion");

                    // Si hay formulario en agendacion.html, puedes rellenarlo así:
                    if (document.getElementById("nombre")) {
                        document.getElementById("nombre").value = nombre || "";
                        document.getElementById("edad").value = edad || "";
                        document.getElementById("motivo").value = motivo || "";
                        document.getElementById("fecha").value = fecha || "";

                        setTimeout(() => {
                            const horaSelect = document.getElementById("hora");
                            if (horaSelect) {
                                const opciones = Array.from(horaSelect.options);
                                const opcion = opciones.find(opt => opt.value === hora);
                                if (opcion && !opcion.disabled) {
                                    horaSelect.value = hora;
                                }
                            }
                        }, 300);
                    }

                    // Y si solo quieres que se actualice la tabla:
                    if (typeof renderTable === "function") {
                        renderTable();
                    }

                } catch (e) {
                    console.warn("Error leyendo datos de subAgendacion:", e);
                }
            }
            fechaInput.value = hoy;
            mostrarHoras(hoy);

            fechaInput.addEventListener("change", function () {
                mostrarHoras(fechaInput.value);
            });
        };

        flatpickr("#fecha", {
            locale: "es",
            dateFormat: "Y-m-d",
            disable: [date => date.getDay() === 0]
        });

        document.getElementById("formCita").addEventListener("submit", function (e) {
            e.preventDefault();

            const nombre = document.getElementById("nombre").value.trim();
            const edad = document.getElementById("edad").value.trim();
            const motivo = document.getElementById("motivo").value.trim();
            const fecha = document.getElementById("fecha").value;
            const hora = document.getElementById("hora").value;

            if (!nombre || !edad || !motivo || !fecha || !hora) {
                alert("Por favor complete todos los campos.");
                return;
            }

            const dia = obtenerDiaDeLaSemana(fecha);
            if (!columnas.includes(dia)) {
                alert("La fecha seleccionada no corresponde a un día hábil.");
                return;
            }

            const horaLimpia = hora.replace(" (Ocupado)", "").trim();
            const indice = franjasHorarias.indexOf(horaLimpia);
            if (indice === -1) {
                alert("Seleccione una franja horaria válida.");
                return;
            }

            const clave = `${fecha}_${dia}_${indice}`;
            const citas = loadCitas();
            if (citas[clave])
            {
                alert("Ya existe una cita para ese día y hora.");
                return;
            }

            citas[clave] =
            {
                valor: `${nombre} · Edad: ${edad} · Motivo: ${motivo} · ${horaLimpia}`,
                homePacientes: true

            };

            saveCitas(citas);
            exportarCitasABaseDeDatos();
            alert("Cita agendada correctamente.");
            mostrarHoras(fecha);
            document.getElementById("formCita").reset();

            // ✅ Actualizar tabla si está presente
            if (typeof renderTable === "function") {
                renderTable();
            }
        });

        // ✅ Sincronización bidireccional con tabla
        window.addEventListener("storage", function (e) {
            if (e.key === "citas") {
                mostrarHoras(document.getElementById("fecha").value);
                if (typeof renderTable === "function") {
                    renderTable();
                }

            }

        });

        function exportarCitasABaseDeDatos() {
            const citas = loadCitas();
            const payload = [];

            for (const [clave, valor] of Object.entries(citas)) {
                const parsed = parseValor(typeof valor === 'object' ? valor.valor : valor);
                const [fecha] = clave.split('_');
                if (!parsed.nombre || !parsed.motivo || !parsed.hora || !fecha) continue;

                payload.push({
                    idPacienteUsuario: null,
                    nombre: parsed.nombre.trim(),
                    motivo: parsed.motivo.trim(),
                    fecha: fecha,
                    hora: parsed.hora.trim()
                });
            }

            fetch("/api/GuardarCitas", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(async res => {
                    const text = await res.text();
                    if (!text) throw new Error("Respuesta vacía del servidor");
                    const data = JSON.parse(text);
                    if (!data.success) throw new Error(data.error || "Error desconocido del servidor");
                    console.log(`✅ ${data.cantidad} citas exportadas al backend.`);
                })
                .catch(err => console.error("❌ Error al exportar citas:", err.message));
        }
        function renderTable() {
            const tbody = document.getElementById("agenda-body");
            if (!tbody) return;

            tbody.innerHTML = ""; // Limpiar tabla

            const citas = loadCitas();

            // Crear una matriz vacía para la tabla: [franja][día]
            const matriz = Array.from({ length: filas }, () => Array(columnas.length).fill(""));

            Object.entries(citas).forEach(([clave, valor]) => {
                const [fecha, dia, indice] = clave.split("_");
                const datos = parseValor(typeof valor === "object" ? valor.valor : valor);
                const diaIndex = columnas.indexOf(dia);
                const franjaIndex = parseInt(indice);

                if (diaIndex >= 0 && franjaIndex >= 0 && franjaIndex < filas) {
                    matriz[franjaIndex][diaIndex] = `${datos.nombre} (${datos.motivo})`;
                }

            });

            // Renderizar la tabla
            for (let i = 0; i < filas; i++) {
                const tr = document.createElement("tr");
                const tdHora = document.createElement("td");
                tdHora.textContent = franjasHorarias[i];
                tdHora.classList.add("hora");
                tr.appendChild(tdHora);

                for (let j = 1; j < columnas.length; j++) { // Saltamos Domingo
                    const td = document.createElement("td");
                    td.textContent = matriz[i][j] || "";
                    tr.appendChild(td);
                }

                tbody.appendChild(tr);
            }
        }
    </script>
</body>
</html>