<!DOCTYPE html>
<html lang="es">
<head>
 <meta charset="utf-8" />
 <title>Inicio Sesión - Pacientes</title>
 <!-- Font Awesome -->
 <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
 <!-- Google Fonts -->
 <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
 <!-- MDB UI Kit -->
 <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/9.2.0/mdb.min.css" rel="stylesheet" />
 <style>
 body { background-color: #a1eaf3; }
 .card { border-radius:1rem; }
 .img-fluid { border-radius:1rem001rem; }
 #loginBtn { width:100%; max-width:340px; display: block; margin:0 auto10px; }
 label { position: absolute; }
 .btn-salir { display: block; width:100%; max-width:340px; margin:0 auto; border-radius:999px; font-weight:600; letter-spacing: .4px; border:2px solid #a1eaf3; color: #00695c; background: #ffffff; }
 .btn-salir:hover { background: #e3f8fb; box-shadow:0px20px rgba(0,0,0,0.08); }
 </style>
</head>
<body>
 <section class="vh-100">
        <div class="container py-5 h-100">
            <div class="row d-flex justify-content-center align-items-center h-100">
                <div class="col col-xl-10">
                    <div class="card">
                        <div class="row g-0">
                            <div class="col-md-6 col-lg-5 d-none d-md-block">
                                <img src="/img/crear.jpg" alt="login form" class="img-fluid" />
                            </div>
                            <div class="col-md-6 col-lg-7 d-flex align-items-center">
                                <div class="card-body p-4 p-lg-5 text-black">
                                    <form>
                                        <h1 class="fw-normal mb-3 pb-3 text-center" style="letter-spacing: 1px;">Dr. Cordova</h1>
                                        <h3 class="text-center">Inicio Sesión</h3>
                                        <h4 class="text-center">Pacientes</h4>

                                        <div class="form-outline mb-4">
                                            <input type="email" id="email" class="form-control form-control-lg" autocomplete="off" required />
                                            <label class="form-label" for="email">Email</label>
                                        </div>

                                        <div class="form-outline mb-4">
                                            <input type="password" id="password" class="form-control form-control-lg" autocomplete="oof" required />
                                            <label class="form-label" for="password">Contraseña</label>
                                        </div>

                                        <div class="pt-1 mb-4">
                                            <button id="loginBtn" class="btn btn-dark btn-lg btn-block" type="button">ENTRAR</button>
                                        </div>

                                        <p class="mb-4 text-center" style="color: #393f81;">
                                            ¿No tienes una cuenta aún? <a href="registrate.html" style="color: #0015ff;">Regístrate aquí</a>
                                        </p>

                                        <!-- Botón Salir con contorno celestito -->
                                        <div class="mb-2 text-center">
                                            <button type="button" class="btn btn-salir" onclick="window.location.href='serviciosPrincipales.html'">
                                                Salir
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- MDB JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/9.2.0/mdb.umd.min.js"></script>
    <script> mdb.Input.init(); </script>

    <!-- Login Script -->
    <script>
    function nsKey(base, id) { return id ? `${base}_${id}` : null; }
    function cleanupGlobalLeakage() {
        try {
            localStorage.removeItem('datosPaciente');
            localStorage.removeItem('fotoPaciente');
            // No tocar chats ni otros per-user
        } catch {}
    }

    document.getElementById('loginBtn').addEventListener('click', async function (e) {
        e.preventDefault();
        document.querySelectorAll('.error').forEach(el => el.remove());

        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        let valido = true;

        function mostrarError(idCampo, mensaje) {
            const campo = document.getElementById(idCampo);
            const error = document.createElement('div');
            error.className = 'error';
            error.style.color = 'red';
            error.style.fontSize = '12px';
            error.textContent = mensaje;
            campo.insertAdjacentElement('afterend', error);
            valido = false;
        }

        if (!email) mostrarError('email', 'El correo es obligatorio');
        if (!password) mostrarError('password', 'La contraseña es obligatoria');
        if (!valido) return;

        try {
            const respuesta = await fetch('https://localhost:7289/api/UsuarioPacientes/validarCredenciales', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password })});
            const resultado = await respuesta.json();

            if (respuesta.ok && resultado.valido) {
                // Set current user id
                const id = resultado.idPacienteUsuario;
                localStorage.setItem('idPacienteUsuario', id);
                // Store email per user, avoid global
                const emailKey = nsKey('emailPaciente', id);
                if (emailKey) localStorage.setItem(emailKey, email);
                // Clean legacy globals that cause mixing
                cleanupGlobalLeakage();
                window.location.href = 'home_pacientes.html';
            } else if (resultado.error === 'email') {
                mostrarError('email', 'Email inválido');
            } else if (resultado.error === 'password') {
                mostrarError('password', 'Clave inválida');
            } else {
                alert('La información no es correcta');
            }
        } catch (error) {
            console.error('Error en la solicitud:', error);
            alert('No se pudo conectar con el servidor');
        }
    });
    </script>

</body>
</html>