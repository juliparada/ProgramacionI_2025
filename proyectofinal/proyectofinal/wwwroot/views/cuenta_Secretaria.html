<!DOCTYPE html>
<html lang="es">
<head>
 <meta charset="UTF-8">
 <title>Registrate</title>
 <style>
 body { font-family: Arial, sans-serif; background-color: #C82909; display: flex; justify-content: center; align-items: center; height:120vh; zoom:100%; }
 .contenedor { background: white; width:500px; border-radius:20px; box-shadow:0010px rgba(0,0,0,0.1); padding:30px70px; display: flex; align-items: center; justify-content: space-between; zoom:110%; }
 .formulario { flex:1; }
 h2 { font-size:22px; margin-bottom:10px; position: relative; }
 h2::before { content: ""; position: absolute; left: -25px; color: black; }
 label { display: block; margin-top:10px; font-weight: bold; }
 input { width:90%; padding:8px; border:1px solid #ccc; border-radius:5px; margin-top:15px; }
 .nota { font-size:12px; color: gray; margin-top:15px; }
 .nota::after { content: " *"; color: red; }
 button { background-color: #4a24ea; color: white; border: none; border-radius:6px; padding:10px20px; margin-top:15px; font-size:16px; cursor: pointer; }
 .doctor { width:120px; margin-left:10px; }
 .error { color: #b30000; font-size:13px; margin-top:8px; }
 .sugerencias span { display: inline-block; background: #eee; border-radius:4px; padding:4px8px; margin:4px4px00; cursor: pointer; font-size:12px; }
 </style>
</head>
<body>
 <div class="contenedor">
 <div class="formulario">
 <h2>Crea una cuenta</h2>
 <p>Administración</p>

 <label for="email">Correo:</label>
 <input id="email" type="email" placeholder="Introduce tu correo">

 <label for="password">Contraseña:</label>
 <input id="password" type="password" placeholder="Introduce tu contraseña">

 <div id="msg" class="error"></div>
 <div id="sugerencias" class="sugerencias"></div>

 <p class="nota">No olvides guardar tus datos</p>

 <button type="button" id="btnSiguiente">Siguiente</button>
 </div>
 <img src="/img/crear.jpg" width="300" height="500" />
 </div>

 <script>
 const btn = document.getElementById('btnSiguiente');
 const email = document.getElementById('email');
 const password = document.getElementById('password');
 const msg = document.getElementById('msg');
 const sug = document.getElementById('sugerencias');

 // Usa siempre el mismo host/puerto donde está sirviéndose esta página
 const API_BASE = window.location.origin;

 function limpiarMensajes() {
 msg.textContent = '';
 sug.innerHTML = '';
 }

 btn.addEventListener('click', async () => {
 limpiarMensajes();
 const e = email.value.trim();
 const p = password.value.trim();

 if (!e || !p) {
 msg.textContent = 'Ingresa email y contraseña.';
 return;
 }

 btn.disabled = true;
 try {
 const res = await fetch(`${API_BASE}/api/UsuarioSecretaria/registrar`, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({ email: e, password: p })
 });

 if (res.status ===404) {
 msg.textContent = `Servicio no encontrado en ${API_BASE}. Verifica que la app esté corriendo en este mismo puerto y que MapControllers esté configurado.`;
 btn.disabled = false;
 return;
 }

 if (res.status ===409) {
 const data = await res.json();
 msg.textContent = data.mensaje || 'la contraseña ya existe';
 if (Array.isArray(data.sugerencias)) {
 data.sugerencias.forEach(s => {
 const chip = document.createElement('span');
 chip.textContent = s;
 chip.title = 'Usar esta sugerencia';
 chip.onclick = () => { password.value = s; limpiarMensajes(); };
 sug.appendChild(chip);
 });
 }
 btn.disabled = false;
 return;
 }

 if (!res.ok) {
 const err = await res.json().catch(() => ({}));
 msg.textContent = err.mensaje || 'No se pudo registrar. Intenta de nuevo.';
 btn.disabled = false;
 return;
 }

 const ok = await res.json();
 localStorage.setItem('idSecretaria', ok.idSecretaria);
 localStorage.setItem('emailSecretaria', ok.email || e);
 window.location.href = 'Datos_administracion.html';
 } catch (error) {
 msg.textContent = 'Error de red. Inténtalo más tarde.';
 } finally {
 btn.disabled = false;
 }
 });
 </script>
</body>
</html>